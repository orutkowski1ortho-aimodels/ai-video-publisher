<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Video Publisher – TikTok Login (Debug Build)</title>
  <style>
    :root{--bg:#0f172a;--fg:#e5e7eb;--btn:#f8fafc;--border:#334155;--ok:#16a34a;--err:#ef4444}
    body{margin:0;padding:28px;background:var(--bg);color:var(--fg);font-family:sans-serif}
    .wrap{max-width:860px;margin:0 auto}
    .btn{padding:10px 18px;border-radius:10px;background:var(--btn);color:#0b1220;text-decoration:none;font-weight:600}
    .btn.gray{background:#111827;color:#e5e7eb;border:1px solid #374151}
    .input{padding:10px;border-radius:8px;border:1px solid var(--border);background:#0b1220;color:var(--fg)}
    .card{margin-top:18px;padding:16px;border:1px solid var(--border);border-radius:12px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    code{background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;padding:10px;border-radius:8px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI Video Publisher – TikTok Login (Debug)</h1>

    <div class="card">
      <h2>1) Wklej Production Client Key</h2>
      <input id="clientKey" class="input" placeholder="Production Client Key" />
      <button class="btn gray" id="saveKeyBtn">Save</button>
      <button class="btn gray" id="clearKeyBtn">Clear</button>
    </div>

    <div class="card">
      <h2>2) Logowanie TikTok</h2>
      <p><a class="btn" id="loginBtn" href="#">Sign in with TikTok</a></p>
      <h3>Pełny link autoryzacji:</h3>
      <pre id="authUrlBox"></pre>
    </div>

    <div class="card">
      <h2>3) Wynik powrotu</h2>
      <div id="result"></div>
      <h3>Query string</h3>
      <pre id="qsBox"></pre>
    </div>
  </div>

  <script>
    const AUTH_BASE = "https://www.tiktok.com/v2/auth/authorize/";
    const SCOPE = "user.info.basic";
    const STATE = "xyz123";

    // Redirect = adres tej strony
    const REDIRECT_URI = (function() {
      let url = window.location.origin + window.location.pathname;
      if (!url.endsWith("/")) {
        if (url.toLowerCase().endsWith("index.html")) {
          url = url.slice(0, -("index.html".length));
        } else { url = url + "/"; }
      }
      return url;
    })();

    const clientKeyInput = document.getElementById("clientKey");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const clearKeyBtn = document.getElementById("clearKeyBtn");
    const loginBtn = document.getElementById("loginBtn");
    const authUrlBox = document.getElementById("authUrlBox");
    const resultEl = document.getElementById("result");
    const qsBox = document.getElementById("qsBox");

    function loadClientKey() {
      const k = localStorage.getItem("tiktok_client_key_prod") || "";
      clientKeyInput.value = k;
      return k;
    }
    function buildAuthUrl(clientKey) {
      const qp = new URLSearchParams({
        client_key: clientKey,
        response_type: "code",
        scope: SCOPE,
        redirect_uri: REDIRECT_URI,
        state: STATE,
      });
      return AUTH_BASE + "?" + qp.toString();
    }
    function refreshAuth() {
      const key = loadClientKey();
      if (!key) {
        authUrlBox.textContent = "sbaw8lk56uu0qhlnsh";
        loginBtn.setAttribute("href", "#");
        return;
      }
      const url = buildAuthUrl(key);
      authUrlBox.textContent = url;
      loginBtn.setAttribute("href", url);
    }
    saveKeyBtn.addEventListener("click", () => {
      const val = (clientKeyInput.value || "").trim();
      if (!val) return;
      localStorage.setItem("tiktok_client_key_prod", val);
      refreshAuth();
      alert("Saved.");
    });
    clearKeyBtn.addEventListener("click", () => {
      localStorage.removeItem("tiktok_client_key_prod");
      clientKeyInput.value = "";
      refreshAuth();
    });

    // Parsowanie odpowiedzi
    (function parseReturn() {
      const qs = window.location.search || "";
      qsBox.textContent = qs || "(no query string)";
      const p = new URLSearchParams(qs);
      const code = p.get("code");
      const state = p.get("state");
      const error = p.get("error");
      const error_desc = p.get("error_description");
      const error_code = p.get("error_code");

      if (error || error_desc || error_code) {
        resultEl.innerHTML = `<p class='err'>❌ OAuth error</p>
          <div class='kv'>
            <div>error</div><div><code>${error||""}</code></div>
            <div>error_description</div><div><code>${decodeURIComponent(error_desc||"")}</code></div>
            <div>error_code</div><div><code>${error_code||""}</code></div>
            <div>state</div><div><code>${state||""}</code></div>
          </div>`;
      } else if (code) {
        resultEl.innerHTML = `<p class='ok'>✅ Received code</p>
          <div class='kv'>
            <div>code</div><div><code>${code}</code></div>
            <div>state</div><div><code>${state||""}</code></div>
          </div>`;
      } else {
        resultEl.innerHTML = "<em>Po logowaniu zobaczysz tu code albo error.</em>";
      }
    })();
    refreshAuth();
  </script>
</body>
</html>
